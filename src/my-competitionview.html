<script type="text/javascript" src="/lib/jquery-3.2.1.min.js"> </script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"> </script>
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<dom-module id="my-competitionview">
    <template>           
        <paper-button raised on-click="submit_query_team"> Magic </paper-button>
        <div id="tablechart">
        </div>
        <div id="switch_candlestick">
        </div>
                
    </template>
    <script>
        google.charts.load('current', {'packages': ["table"]});
        class MyCompetitionView extends Polymer.Element {
            static get is() { return 'my-competitionview' }
            submit_query_team() {
                var base = this;
                $.ajax({
                    url: "/getteamdata",
                    type: "GET",
                    success: function(data) {
                        base.generate_graph(data, base);        
                    }
                });
            }

            generate_graph(data,base) {
                google.charts.load('45', {packages: ['corechart', 'table']});
                google.charts.setOnLoadCallback(function() {base.drawTable(data,base);});
                google.charts.setOnLoadCallback(function() {base.drawSwitchCandle(data,base);});
            } 

            drawDataTable(data, base, table) {
                table.addColumn('string', 'Team Number');
                table.addColumn('number', 'Avg Scale Cubes in Auton');
                table.addColumn('number', 'Avg Switch Cubes in Auton');
                table.addColumn('number', 'Avg Alliance Switch Cubes in Teleop');
                table.addColumn('number', 'Avg Opposing Switch Cubes in Teleop');
                table.addColumn('number', 'Avg Scale Cubes in Teleop');
                table.addColumn('number', 'Avg Exchange Cubes');
                console.log(data);
                for (var team in data) {
                    var stat = [];
                    stat.push(team);
                    stat.push(base.average(data[team], "autonScaleCubes"));
                    stat.push(base.average(data[team], "autonSwitchCubes"));
                    stat.push(base.average(data[team], "allianceSwitchCubes"));
                    stat.push(base.average(data[team], "opposingSwitchCubes"));
                    stat.push(base.average(data[team], "teleopScaleCubes"));
                    stat.push(base.average(data[team], "exchange"));
                    table.addRow(stat);

                }
    
            }
            
            average(data, key) {
                var sum = 0.0;
                var amount = 0;
                data.forEach(function(match) {   
                    sum += match[key];
                    amount++;
                });
                return sum/amount;
            }

            drawTable(data, base) {
                var table = new google.visualization.DataTable();
                base.drawDataTable(data, base, table);
                var options = {"allowHtml": "true",
                    "title": "Competition View",
                    "page": "enable",
                    "pageSize": 3,
                    "pagingButtons": "both"};
                
                var chart = new google.visualization.Table(base.$.tablechart);
                chart.draw(table, options); 
            }
            
            drawSwitchStat(data, key, team) {
                var teamstats = [];
                teamstats.push(team);
                data.forEach(function(match) {
                    teamstats.push(match[key]);                  
                });
                return teamstats;i
            }

            drawSwitchCandle(data, base) {
                var arr = [];
                for (var team in data) {
                    arr.push(base.drawSwitchStat(data[team], "allianceSwitchCubes", team));
                }
                console.log(arr);
                var table = google.visualization.arrayToDataTable(arr, true);
                var options={
                    legend : 'none'
                };

                var chart = new google.visualization.CandlestickChart(base.$.switch_candlestick);
                chart.draw(table, options);
            }
        }
    window.customElements.define(MyCompetitionView.is, MyCompetitionView);
    </script>
</dom-module>
